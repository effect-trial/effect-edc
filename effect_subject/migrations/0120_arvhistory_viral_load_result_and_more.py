# Generated by Django 5.1.3 on 2024-12-10 12:43

import django.core.validators
from django.db import migrations, models
from tqdm import tqdm


class DataMigrationError(Exception):
    pass


def migrate_retired_vl_result_to_vl_result(apps, schema_editor):
    model_cls = apps.get_model("effect_subject.arvhistory")
    qs = model_cls.objects.all()
    total = qs.count()

    print(
        f"\nMigrating {total} Arv History `retired_viral_load_result` "
        "to `viral_load_result` ..."
    )
    for obj in tqdm(qs, total=total):
        if obj.retired_viral_load_result:
            obj.viral_load_result = int(obj.retired_viral_load_result)
            obj.save()
            print(
                f"Migrated {obj} vl from {obj.retired_viral_load_result:>10} "
                f"to {obj.viral_load_result}"
            )
    print("Done migrating")


def verify_vl_result_migration(apps, schema_editor):
    model_cls = apps.get_model("effect_subject.arvhistory")
    qs = model_cls.objects.all()
    total = qs.count()

    print(
        f"\nVerifying {total} Arv History `viral_load_result` against "
        "`retired_viral_load_result` ..."
    )
    for obj in tqdm(qs, total=total):
        if obj.viral_load_result != obj.retired_viral_load_result:
            raise DataMigrationError(
                "Error. Expected `viral_load_result` to equal `retired_viral_load_result`."
                f"Got {obj.viral_load_result=} and {obj.retired_viral_load_result=}."
            )
    print("Done verifying")


class Migration(migrations.Migration):

    dependencies = [
        (
            "effect_subject",
            "0119_rename_viral_load_result_arvhistory_retired_viral_load_result_and_more",
        ),
    ]

    operations = [
        migrations.AddField(
            model_name="arvhistory",
            name="viral_load_result",
            field=models.IntegerField(
                blank=True,
                help_text="copies/mL",
                null=True,
                validators=[
                    django.core.validators.MinValueValidator(1),
                    django.core.validators.MaxValueValidator(9999999),
                ],
                verbose_name="Viral load result",
            ),
        ),
        migrations.AddField(
            model_name="historicalarvhistory",
            name="viral_load_result",
            field=models.IntegerField(
                blank=True,
                help_text="copies/mL",
                null=True,
                validators=[
                    django.core.validators.MinValueValidator(1),
                    django.core.validators.MaxValueValidator(9999999),
                ],
                verbose_name="Viral load result",
            ),
        ),
        migrations.RunPython(migrate_retired_vl_result_to_vl_result),
        migrations.AlterField(
            model_name="arvhistory",
            name="retired_viral_load_result",
            field=models.DecimalField(
                blank=True,
                decimal_places=3,
                help_text="copies/mL (retired/superseded in effect-edc 0.1.57 by `viral_load_result` IntegerField, see also #658)",
                max_digits=10,
                null=True,
                validators=[
                    django.core.validators.MinValueValidator(1),
                    django.core.validators.MaxValueValidator(9999999),
                ],
                verbose_name="Viral load result (retired/superseded in effect-edc 0.1.57 by `viral_load_result` IntegerField, see also #658)",
            ),
        ),
        migrations.AlterField(
            model_name="historicalarvhistory",
            name="retired_viral_load_result",
            field=models.DecimalField(
                blank=True,
                decimal_places=3,
                help_text="copies/mL (retired/superseded in effect-edc 0.1.57 by `viral_load_result` IntegerField, see also #658)",
                max_digits=10,
                null=True,
                validators=[
                    django.core.validators.MinValueValidator(1),
                    django.core.validators.MaxValueValidator(9999999),
                ],
                verbose_name="Viral load result (retired/superseded in effect-edc 0.1.57 by `viral_load_result` IntegerField, see also #658)",
            ),
        ),
        migrations.RunPython(verify_vl_result_migration),
    ]
